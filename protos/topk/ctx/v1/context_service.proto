syntax = "proto3";
package topk.ctx.v1;

import "topk/data/v1/expr/logical.proto";

service ContextService {
    rpc Ask(AskRequest) returns (stream AskResponseMessage);
}

message Source {
    string dataset = 1;
    topk.data.v1.LogicalExpr filter = 2;
}

message SearchResult {
    string id = 1;
    oneof content {
        string text = 101;
        Png png = 102;
        Jpeg jpeg = 103;
    }
    string doc_id = 2;
    repeated uint32 doc_pages = 3;
}

message Png {
    bytes data = 1;
}

message Jpeg {
    bytes data = 1;
}

message Fact {
    string fact = 1;
    repeated string source_ids = 2;
}

enum Effort {
    EFFORT_UNSPECIFIED = 0;
    EFFORT_MEDIUM = 1;
    EFFORT_LOW = 2;
    EFFORT_HIGH = 3;
}

message AskRequest {
    string query = 1;
    repeated Source sources = 2;
    topk.data.v1.LogicalExpr filter = 3;
    Effort effort = 4;
}

message AskResponseMessage {
    message SubQuery {
        string objective = 1;
        repeated Fact facts = 2;
        map<string, SearchResult> sources = 3;
    }

    message Reason {
        string thought = 1;
    }

    message FinalAnswer {
        repeated Fact facts = 1;
        map<string, SearchResult> sources = 2;
    }

    oneof message {
        FinalAnswer final_answer = 1;
        SubQuery sub_query = 2;
        Reason reason = 3;
    }
}
