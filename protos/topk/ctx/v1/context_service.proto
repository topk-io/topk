syntax = "proto3";
package topk.ctx.v1;

import "topk/data/v1/expr/logical.proto";
import "topk/data/v1/value.proto";

service ContextService {
    // Get a summarized answer to a question based on provided sources.
    rpc Ask(AskRequest) returns (stream AskResponseMessage);

    // Get search results from the provided sources.
    rpc Search(SearchRequest) returns (stream SearchResult);
}

message Source {
    string dataset = 1;
    topk.data.v1.LogicalExpr filter = 2;
}

message SearchResult {
    string source_doc_id = 1;
    string source_doc_type = 2;
    Content content = 3;
    map<string, topk.data.v1.Value> metadata = 4;
}

message Content {
    oneof data {
        Chunk chunk = 1;
        Page page = 2;
        Image image = 3;
    }
}

message Page {
    uint32 page_number = 1;
    bytes image = 2;
}

message Chunk {
    string text = 1;
}

message Image {
    bytes data = 1;
}

message Fact {
    string fact = 1;
    repeated string refs_ids = 2;
}

enum Effort {
    EFFORT_UNSPECIFIED = 0;
    EFFORT_SUMMARIZE = 1;
    EFFORT_REASON = 2;
    EFFORT_DEEP_RESEARCH = 3;
}

message AskRequest {
    string query = 1;
    repeated Source sources = 2;
    topk.data.v1.LogicalExpr filter = 3;
    Effort effort = 4;
}

message AskResponseMessage {
    message Search {
        string objective = 1;
        repeated Fact facts = 2;
        map<string, SearchResult> refs = 3;
    }

    message Reason {
        string thought = 1;
    }

    message FinalAnswer {
        repeated Fact facts = 1;
        map<string, SearchResult> refs = 2;
    }

    oneof message {
        FinalAnswer final_answer = 1;
        Search search = 2;
        Reason reason = 3;
    }
}

message SearchRequest {
    string query = 1;
    repeated Source sources = 2;
    topk.data.v1.LogicalExpr filter = 3;
    uint32 top_k = 4;
}
