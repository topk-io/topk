syntax = "proto3";
package topk.ctx.v1;

import "topk/data/v1/value.proto";

service DatasetWriteService {
  // Upsert document
  rpc Upsert(stream UpsertMessage) returns (UpsertResponse);

  // Update document metadata
  rpc UpdateMetadata(UpdateMetadataRequest) returns (UpdateMetadataResponse);

  // Delete document
  rpc Delete(DeleteRequest) returns (DeleteResponse);

  // Check if document is ready for reading
  rpc CheckHandle(CheckHandleRequest) returns (CheckHandleResponse);
}

message UpsertMessage {
  message Header {
    string id = 1;
    string mime_type = 2;
    map<string, topk.data.v1.Value> metadata = 3;
    uint64 size = 4;
    string name = 5;
  }

  message BodyChunk {
    uint64 seq = 1;
    bytes data = 2;
  }

  oneof message {
    Header header = 1;
    BodyChunk body_chunk = 2;
  }
}

message UpsertResponse {
  string handle = 1;
}

message UpdateMetadataRequest {
  string id = 1;
  map<string, topk.data.v1.Value> metadata = 2;
}

message UpdateMetadataResponse {
  string handle = 1;
}

message DeleteRequest {
  string id = 1;
}

message DeleteResponse {
  string handle = 1;
}

message CheckHandleRequest {
  string handle = 1;
}

message CheckHandleResponse {
  bool processed = 1;
}
